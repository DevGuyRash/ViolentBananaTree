{
  "id": "snapshot_1761020193830_h4aeuie69",
  "approvalId": "approval_1761019385434_olpbr6dh3",
  "approvalTitle": "workflow-engine-dsl design approval",
  "version": 2,
  "timestamp": "2025-10-21T04:16:33.830Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe DGX workflow engine transforms recorder output and hand-authored DSL definitions into reliable, observable browser automations. This design formalizes the engine runtime, declarative step schema, configuration defaults, and telemetry adapters that let page modules execute workflows with consistent timing, retries, context access, and logical-key resolution while keeping HUD and recorder tooling in sync.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- Adheres to the TypeScript-first stack with strict typing inside `packages/workflows`.\n- Reuses existing Vite/WXT build outputs by keeping runtime browser-safe and free of `eval`.\n- Integrates with GM storage, BroadcastChannel, and `[DGX]` logging conventions for observability.\n\n### Project Structure (structure.md)\n- Places DSL types, config, and engine code under `packages/workflows/src` with dedicated barrels in `index.ts`.\n- Consumes selector resolution from `packages/core` and context store from `packages/context`, maintaining modular package boundaries.\n- Exposes workflow APIs through page modules in `packages/scripts/<site>/<page>.ts`, aligning with existing registry patterns.\n\n## Code Reuse Analysis\n- `@core/resolve` supplies logical-key lookup with stability metadata used during step execution.\n- `@core/utils/wait`, `scroll`, and `collect` provide low-level DOM helpers invoked by engine actions.\n- `@context/store` offers TTL-aware context management injected into the engine.\n- HUD (`@menu`) and recorder (`@recorder`) leverage the same telemetry events and type definitions for timeline playback and export.\n\n### Existing Components to Leverage\n- **SelectorResolver (`@core/resolve`)**: Resolves logical keys with strategy ordering; engine wraps it for workflow steps.\n- **ContextStore (`@context/store`)**: Manages cross-tab state referenced by `setContext`, `fromCtx`, and `foreach` loops.\n- **Wait Utilities (`@core/utils/wait`)**: Implements polling with configurable intervals backing `waitFor`, `waitText`, and retry loops.\n- **Scroll & List Utilities (`@core/utils/scroll`, `@core/utils/collect`)**: Power `scrollUntil` and `collectList` step kinds.\n\n### Integration Points\n- **HUD Timeline**: Subscribes to engine telemetry stream to render per-step status and durations.\n- **Recorder Export**: Serializes recorded actions into DSL `Step[]` using shared type definitions.\n- **Telemetry Adapter**: Emits structured events to console (`[DGX]`) and optional future sinks.\n- **Workflow Registry**: Page modules register workflows with engine factory to ensure step definitions map to selector maps.\n\n## Architecture\n\nThe engine is composed of four cooperating modules:\n1. **DSL Types & Validator**: TypeScript union definitions plus runtime guards ensuring recorder output aligns with engine expectations.\n2. **Execution Engine**: Runs steps sequentially with support for nested workflows, branching, retries, and context interaction.\n3. **Action Executors**: Encapsulate DOM side effects (click/type/select/etc.) and reuse shared utilities.\n4. **Telemetry & Error Layer**: Captures structured events, errors, and metrics for HUD, recorder, and potential analytics.\n\n### Modular Design Principles\n- **Single File Responsibility**: `types.ts` declares DSL contracts, `engine.ts` orchestrates execution, `actions/*.ts` isolate action-specific behavior, and `telemetry.ts` handles logging.\n- **Component Isolation**: Execution engine depends on injected resolver, context store, and telemetry adapters rather than importing concrete implementations.\n- **Service Layer Separation**: Page modules build workflow descriptors; the engine consumes descriptors without knowledge of UI/hotkeys.\n- **Utility Modularity**: Each step kind delegates to specialized helpers (e.g., `executeClick`, `executeWaitFor`) avoiding monolithic switch blocks.\n\n```mermaid\ngraph TD\n    Recorder[Recorder Export] -->|Step[]| Types[DSL Types]\n    Types --> Engine[Workflow Engine]\n    Engine --> Actions[Action Executors]\n    Engine --> Telemetry[Telemetry Adapter]\n    Actions --> Resolver[Logical Selector Resolver]\n    Actions --> Context[Context Store]\n    Telemetry --> HUD[HUD Timeline]\n    Telemetry --> Console[[DGX Logs]]\n```\n\n## Components and Interfaces\n\n### DSL Types (`types.ts`)\n- **Purpose:** Define `Step`, `Workflow`, `WorkflowConfig`, and telemetry payload types.\n- **Interfaces:** `Step`, `WorkflowDefinition`, `WorkflowRunOptions`, `StepError`, `StepTelemetry`.\n- **Dependencies:** Type-only references to core utility types; no runtime imports.\n- **Reuses:** Aligns with recorder-generated TypeScript types to ensure interoperability.\n\n### Workflow Engine (`engine.ts`)\n- **Purpose:** Execute workflows sequentially or recursively with retries, conditionals, and context operations.\n- **Interfaces:** `runWorkflow(workflowId, opts)`, `runSteps(steps, scope)`, `cancelRun(runId)`.\n- **Dependencies:** Injected `SelectorResolver`, `ContextStore`, `TelemetryAdapter`, `DefaultConfig`.\n- **Reuses:** Wait utilities, scroll helpers, and context store adapters from existing packages.\n\n### Action Executors (`actions/*.ts`)\n- **Purpose:** Implement side-effect logic for each step kind (click, type, select, waitFor, assert, foreach, log, etc.).\n- **Interfaces:** `execute(step, env): Promise<StepResult>` per action type.\n- **Dependencies:** DOM utility helpers, resolver, context store, sanitizers.\n- **Reuses:** `@core/utils/wait`, `@core/utils/scroll`, `@core/utils/collect`, `@core/utils/dom`.\n\n### Telemetry Adapter (`telemetry.ts`)\n- **Purpose:** Normalize engine events (start, attempt, success, failure) into `[DGX]` console logs and HUD timeline entries.\n- **Interfaces:** `record(event: StepTelemetry)`, `flush(runId)`, `onUpdate(listener)`.\n- **Dependencies:** Sanitizer utilities, HUD event bus, optional analytics pipeline hook.\n- **Reuses:** Logging conventions defined in tech steering.\n\n### Config & Defaults (`config.ts`)\n- **Purpose:** Store default timeouts, intervals, retry strategies, and error message templates.\n- **Interfaces:** `WorkflowDefaults`, `resolveTimeout(step, overrides)`, `resolveRetryPolicy(step)`.\n- **Dependencies:** None beyond TypeScript types.\n- **Reuses:** Values sourced from steering (≤150ms polling, ≤8s default timeouts).\n\n### Workflow Registry (`registry.ts`)\n- **Purpose:** Map workflow IDs to metadata and step definitions within a page module context.\n- **Interfaces:** `registerWorkflows(pageId, workflows)`, `getWorkflow(pageId, workflowId)`.\n- **Dependencies:** Page module definitions.\n- **Reuses:** Existing `packages/scripts/index.ts` registration pipeline.\n\n## Data Models\n\n### Step\n```\ntype Step =\n  | { kind: \"click\"; key: string; timeout?: number; retries?: number; backoffMs?: number; jitterMs?: number; name?: string; debug?: boolean }\n  | { kind: \"type\"; key: string; text?: string; fromCtx?: string; delayMs?: number; timeout?: number; retries?: number }\n  | { kind: \"select\"; key: string; value?: string; fromCtx?: string; timeout?: number }\n  | { kind: \"waitFor\"; key?: string; css?: string; xpath?: string; text?: string; exact?: boolean; timeout?: number; interval?: number }\n  | { kind: \"if\"; when: Condition; then: Step[]; else?: Step[] }\n  | { kind: \"foreach\"; listCtx: string; as: string; steps: Step[]; concurrency?: number }\n  | { kind: \"setContext\"; path: string; value?: unknown; fromKey?: string; fromText?: string; ttlMs?: number }\n  | { kind: \"capture\"; to: string; from: CaptureSource; sanitize?: boolean }\n  | { kind: \"assert\"; check: Assertion; timeout?: number }\n  | { kind: \"log\"; message: string; level?: \"info\" | \"warn\" | \"error\" }\n  | { kind: \"delay\"; ms: number }\n  | { kind: \"run\"; workflowId: string }\n  | { kind: \"scrollUntil\"; options: ScrollUntilOptions }\n  | { kind: \"collectList\"; options: CollectOptions; toCtx?: string }\n  | { kind: \"retry\"; steps: Step[]; policy?: RetryPolicy }\n  | { kind: \"hover\"; key: string }\n  | { kind: \"focus\"; key: string }\n  | { kind: \"blur\"; key: string };\n```\n\n### Workflow Definition\n```\ntype WorkflowDefinition = {\n  id: string;\n  label: string;\n  steps: Step[];\n  defaults?: WorkflowDefaults;\n  description?: string;\n  tags?: string[];\n};\n```\n\n### StepTelemetry\n```\ntype StepTelemetry = {\n  runId: string;\n  workflowId: string;\n  stepIndex: number;\n  stepKind: string;\n  logicalKey?: string;\n  status: \"pending\" | \"attempt\" | \"success\" | \"failure\" | \"skipped\";\n  attempt: number;\n  timestamp: number;\n  durationMs?: number;\n  error?: StepError;\n  notes?: string;\n};\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **Resolver Miss:** Logical key strategies exhaust without finding an element.\n   - **Handling:** Engine emits `failure` telemetry, attaches selector strategies attempted, respects retry policy, and ultimately surfaces `StepError` with actionable message.\n   - **User Impact:** HUD shows miss with logical key and stability score; workflow stops unless caller handles error.\n\n2. **Context Access Failure:** `fromCtx` or `foreach` references undefined context path.\n   - **Handling:** Engine throws typed error with missing path, allowing fallback steps or abort based on workflow defaults.\n   - **User Impact:** HUD surfaces context miss; recorder suggests adding `setContext` or default value.\n\n3. **Timeout:** Wait/action exceeds configured timeout.\n   - **Handling:** Engine cancels pending DOM loops, logs timeout with elapsed duration, and returns structured error including default overrides used.\n   - **User Impact:** HUD timeline marks step red with timeout reason; telemetry captures for later diagnosis.\n\n4. **Assertion Failure:** Expected condition not satisfied within retries.\n   - **Handling:** Engine emits failure telemetry with expected vs actual values and halts workflow by default.\n   - **User Impact:** HUD displays assertion context; optional on-fail steps can handle recovery in future iterations.\n\n## Testing Strategy\n\n### Unit Testing\n- Cover DSL validators ensuring invalid steps reject at build/test time.\n- Mock resolver/context to test engine branching, retries, and telemetry emission.\n- Validate each action executor in isolation (click/type/select/assert) using JSDOM or DOM stubs.\n\n### Integration Testing\n- Run engine against synthetic DOM fixtures to confirm logical key resolution, context updates, and nested workflow execution.\n- Verify telemetry stream consumed by HUD mock to ensure event ordering and payload integrity.\n- Exercise recorder export/import loop to confirm type compatibility and default merging.\n\n### End-to-End Testing\n- Execute sample workflows in browser automation (Playwright/Cypress) to validate real DOM interactions, scroll behaviors, and timeline feedback through HUD.\n- Test failure paths (selector miss, timeout, assertion failure) to ensure error signaling matches acceptance criteria and telemetry captures masked data when required.\n",
  "fileStats": {
    "size": 10876,
    "lines": 189,
    "lastModified": "2025-10-21T04:02:56.015Z"
  },
  "comments": []
}